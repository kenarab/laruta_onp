"use strict";angular.module("onpApp",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("onpApp").controller("MainCtrl",["$scope",function(a){a.setYear=function(b){a.year=b,a.data=a.alldata.filter(function(a){return parseInt(a.anio)==b})},a.init=function(){d3.csv("data/onp-presupuesto_indicadores.csv",function(b){a.alldata=b,a.setYear(2013),a.$apply()})},a.$watch("year",function(b){parseInt(b)>2002&&parseInt(b)<2015&&a.setYear(b)})}]),angular.module("onpApp").directive("vis",function(){function a(a){var b=r.filter(function(b){return b.name==a});return b.length>0?b[0]:{name:"Other",department:{x:0,y:0}}}function b(a){return-Math.pow(a.radius,2)/8}function c(){n.gravity(o).nodes(m).charge(b).friction(.9).on("tick",function(a){h.each(e(a.alpha)).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}).on("mouseover",s.show).on("mouseout",s.hide)}),n.start()}function d(){n.gravity(o).nodes(m).charge(b).friction(.9).on("tick",function(a){h.each(f(a.alpha)).attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})}),n.start()}function e(a){return function(b){b.x=b.x+(l.x-b.x)*(p+.02)*a,b.y=b.y+(l.y-b.y)*(p+.02)*a}}function f(a){return function(b){var c=b.positions.department.x,d=b.positions.department.y;b.x=b.x+(c-b.x)*(p+.02)*a,b.y=b.y+(d-b.y)*(p+.02)*a}}var g,h,i={top:0,right:0,bottom:0,left:0},j=730-i.left-i.right,k=730-i.top-i.bottom,l={x:j/2,y:k/2},m=[],n=d3.layout.force().nodes(m).size([j,k]),o=-.01,p=.1,q=null,r=[{name:"Básico",department:{x:200,y:200},title:{x:-40,y:-170}},{name:"Productivo",department:{x:400,y:200},title:{x:30,y:-170}},{name:"Interior",department:{x:600,y:200},title:{x:60,y:-170}},{name:"Ejecutivo",department:{x:200,y:400},title:{x:-40,y:-50}},{name:"Exterior",department:{x:350,y:400},title:{x:-20,y:-50}},{name:"Financiero",department:{x:450,y:400},title:{x:20,y:-50}},{name:"Institucional",department:{x:600,y:400},title:{x:60,y:-50}}],s=d3.tip().attr("class","d3-tip").html(function(a){return"<span>Categoria: "+a.category+"</span><br><span>Jurisdicción: "+a.jurisdiction+"</span></span><br><span>Presupuesto Ejecutado: "+a.presupuesto_ejec+"</span></span><br><span>Presupuesto Proyectado: "+t(a.value_proy)}),t=d3.format("0,000"),u=d3.scale.pow().exponent(.5).domain([0,1e9]).range([1,90]),v=d3.scale.ordinal().domain([-3,-2,-1,0,1,2,3]).range(["#d84b2a","#ee9586","#e4b7b2","#AAA","#beccae","#9caf84","#7aa25c"]),w=d3.scale.ordinal().domain([-3,-2,-1,0,1,2,3]).range(["#c72d0a","#e67761","#d9a097","#999","#a7bb8f","#7e965d","#5a8731"]),x=d3.scale.ordinal().domain([.5,1.5]).range([-3,-2,-1,0,1,2,3]);return{restrict:"E",scope:{data:"=",layout:"=",dataloaded:"="},link:function(b,e){g=d3.select($(e)[0]).append("svg").attr("width",j).attr("height",k).append("g").attr("transform","translate("+i.left+","+i.top+")").call(s),g.selectAll(".category-labels").data(r).enter().append("text").attr("class","category-labels").style("opacity",0).attr("x",function(a){return a.department.x+a.title.x}).attr("y",function(a){return a.department.y+a.title.y}).attr("text-anchor","middle").text(function(a){return a.name}),b.$watch("layout",function(a){a&&("jurisdiction"==a?(d(),g.selectAll(".category-labels").transition().duration(2e3).style("opacity",1)):(c(),g.selectAll(".category-labels").transition().duration(200).style("opacity",0)))}),b.$watch("data",function(d){if(d){var e=d.filter(function(a){return"TOTAL"!=a.categoria}),f=d.filter(function(a){return"TOTAL"==a.categoria});u.domain([0,d3.max(e,function(a){return parseInt(a.value_exec,10)})]),m=[];for(var i=0;i<e.length;i++)m.push({index:i,sid:e[i].id,radius:u(parseInt(e[i].value_exec,10)),value:parseInt(e[i].value_exec,10),value_proy:parseInt(e[i].value_proy,10),presupuesto_ejec:t(parseInt(e[i].value_exec,10)),year:b.year,x:900*Math.random(),y:800*Math.random(),category:e[i].categoria,jurisdiction:e[i].juris_abrev,changeCategory:x(e[i].value_exec/e[i].value_proy),positions:a(e[i].categoria)});m.sort(function(a,b){return Math.abs(b.value)-Math.abs(a.value)}),q=u(f.value),h=g.selectAll("circles").data(m),h.enter().append("circle").attr("r",0).attr("id",function(a){return a.id}).style("fill",function(a){return v(a.changeCategory)}).style("stroke-width",1).style("stroke",function(a){return w(a.changeCategory)}),h.transition().duration(2e3).attr("r",function(a){return a.radius}),h.exit().remove(),b.layout="all",c()}})}}});